<div class="min-h-screen bg-surface-ground p-6">
  <p-toast />

  <div class="w-full max-w-7xl mx-auto">

    <!-- Header con acciones -->
    <div class="mb-6 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <p-button
          icon="pi pi-arrow-left"
          [rounded]="true"
          [text]="true"
          severity="secondary"
          (onClick)="volver()"
          pTooltip="Volver"
        />
        @if (!loading() && detalle()) {
          <div>
            <h1 class="text-3xl font-bold text-surface-900 dark:text-surface-0">
              Orden {{ detalle()!.numeroOrden }}
            </h1>
            <p class="text-surface-600 dark:text-surface-400 mt-1">
              {{ detalle()!.nombreCompleto }}
            </p>
          </div>
        }
      </div>

      @if (!loading() && detalle()) {
        <div class="flex gap-2">
          <p-button
            icon="pi pi-map-marker"
            label="Ver mapa"
            [outlined]="true"
            severity="secondary"
            (onClick)="abrirMapa()"
          />
          <p-button
            icon="pi pi-calendar-plus"
            label="Nueva Visita"
            [outlined]="true"
            (onClick)="abrirDialogVisita()"
            [disabled]="!puedeCrearVisita()"
          />
          <p-button
            icon="pi pi-comment"
            label="Nueva Interacción"
            [outlined]="true"
            (onClick)="abrirDialogInteraccion()"
          />
        </div>
      }
    </div>

    <!-- Loading skeleton -->
    @if (loading()) {
      <div class="space-y-4">
        <p-skeleton width="100%" height="200px" />
        <p-skeleton width="100%" height="300px" />
      </div>
    }

    <!-- Contenido principal -->
    @if (!loading() && detalle()) {
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Columna izquierda: Info del cliente y orden -->
        <div class="lg:col-span-2 space-y-6">

          <!-- Información General -->
          <p-card header="Información General">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="text-sm font-semibold text-surface-600 dark:text-surface-400">Nº Orden</label>
                <p class="text-surface-900 dark:text-surface-0 font-mono mt-1">{{ detalle()!.numeroOrden }}</p>
              </div>
              <div>
                <label class="text-sm font-semibold text-surface-600 dark:text-surface-400">Código Cliente</label>
                <p class="text-surface-900 dark:text-surface-0 font-mono mt-1">{{ detalle()!.codigoCliente }}</p>
              </div>
              <div>
                <label class="text-sm font-semibold text-surface-600 dark:text-surface-400">Estado</label>
                <div class="mt-1">
                  <p-tag
                    [value]="detalle()!.estadoOrdenTrabajo"
                    [severity]="getSeverityEstadoOrden(detalle()!.estadoOrdenTrabajo)"
                  />
                </div>
              </div>
              <div>
                <label class="text-sm font-semibold text-surface-600 dark:text-surface-400">Prioridad</label>
                <div class="mt-1">
                  <p-tag
                    [value]="detalle()!.prioridad"
                    [severity]="getSeverityPrioridad(detalle()!.prioridad)"
                  />
                </div>
              </div>
              <div>
                <label class="text-sm font-semibold text-surface-600 dark:text-surface-400">Tipo Cliente</label>
                <p class="text-surface-900 dark:text-surface-0 mt-1">{{ detalle()!.tipoCliente }}</p>
              </div>
              <div>
                <label class="text-sm font-semibold text-surface-600 dark:text-surface-400">Agend. Línea</label>
                <div class="mt-1">
                  <p-tag [value]="detalle()!.agendamientoLinea" />
                </div>
              </div>
            </div>
          </p-card>

          <!-- Información del Cliente -->
          <p-card header="Datos del Cliente">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="md:col-span-2">
                <label class="text-sm font-semibold text-surface-600 dark:text-surface-400">Nombre Completo</label>
                <p class="text-surface-900 dark:text-surface-0 mt-1">{{ detalle()!.nombreCompleto }}</p>
              </div>
              <div class="md:col-span-2">
                <label class="text-sm font-semibold text-surface-600 dark:text-surface-400">Dirección</label>
                <p class="text-surface-900 dark:text-surface-0 mt-1">{{ detalle()!.direccion }}</p>
                @if (detalle()!.observacionDireccion) {
                  <p class="text-surface-600 dark:text-surface-400 text-sm mt-1">
                    <i class="pi pi-info-circle mr-1"></i>{{ detalle()!.observacionDireccion }}
                  </p>
                }
              </div>
              <div>
                <label class="text-sm font-semibold text-surface-600 dark:text-surface-400">Teléfono</label>
                <p class="text-surface-900 dark:text-surface-0 mt-1">
                  <i class="pi pi-phone mr-2"></i>{{ detalle()!.telefono }}
                </p>
              </div>
              <div>
                <label class="text-sm font-semibold text-surface-600 dark:text-surface-400">Código Postal</label>
                <p class="text-surface-900 dark:text-surface-0 mt-1">{{ detalle()!.codigoPostal }}</p>
              </div>
              <div>
                <label class="text-sm font-semibold text-surface-600 dark:text-surface-400">Departamento</label>
                <p class="text-surface-900 dark:text-surface-0 mt-1">{{ detalle()!.departamento }}</p>
              </div>
              <div>
                <label class="text-sm font-semibold text-surface-600 dark:text-surface-400">Provincia</label>
                <p class="text-surface-900 dark:text-surface-0 mt-1">{{ detalle()!.provincia }}</p>
              </div>
              <div>
                <label class="text-sm font-semibold text-surface-600 dark:text-surface-400">Distrito</label>
                <p class="text-surface-900 dark:text-surface-0 mt-1">{{ detalle()!.distrito }}</p>
              </div>
              <div>
                <label class="text-sm font-semibold text-surface-600 dark:text-surface-400">Sucursal</label>
                <p class="text-surface-900 dark:text-surface-0 mt-1">{{ detalle()!.sucursalNombre }}</p>
              </div>
            </div>
          </p-card>

          <!-- Tareas -->
          <p-card>
            <ng-template pTemplate="header">
              <div class="flex items-center justify-between p-4">
                <span class="font-semibold text-lg">Tareas ({{ detalle()!.tareas.length }})</span>
              </div>
            </ng-template>

            <div class="space-y-3">
              @for (tarea of detalle()!.tareas; track tarea.tareaId) {
                <div class="p-4 border border-surface-200 dark:border-surface-700 rounded-lg">
                  <div class="flex items-start justify-between mb-2">
                    <div class="flex-1">
                      <div class="flex items-center gap-2 mb-1">
                        <span class="font-mono text-sm text-surface-600 dark:text-surface-400">
                          {{ tarea.numeroTarea }}
                        </span>
                        <p-tag
                          [value]="tarea.estadoTarea"
                          [severity]="getSeverityEstadoTarea(tarea.estadoTarea)"
                          styleClass="text-xs"
                        />
                      </div>
                      <p class="font-semibold text-surface-900 dark:text-surface-0">{{ tarea.tipoServicio }}</p>
                      @if (tarea.descripcion) {
                        <p class="text-surface-600 dark:text-surface-400 text-sm mt-1">{{ tarea.descripcion }}</p>
                      }
                    </div>
                  </div>

                  <div class="flex items-center gap-4 text-sm text-surface-600 dark:text-surface-400 mt-3">
                    <span>
                      <i class="pi pi-calendar mr-1"></i>
                      {{ tarea.fechaCreacion | date: 'dd/MM/yyyy HH:mm' }}
                    </span>
                    @if (tarea.atendidoPor) {
                      <span>
                        <i class="pi pi-user mr-1"></i>
                        {{ tarea.atendidoPor }}
                      </span>
                    }
                    @if (tarea.fechaAtencion) {
                      <span>
                        <i class="pi pi-check mr-1"></i>
                        {{ tarea.fechaAtencion | date: 'dd/MM/yyyy HH:mm' }}
                      </span>
                    }
                  </div>
                </div>
              }

              @if (detalle()!.tareas.length === 0) {
                <div class="text-center py-8 text-surface-500">
                  <i class="pi pi-inbox text-4xl mb-3 block"></i>
                  <p>No hay tareas registradas</p>
                </div>
              }
            </div>
          </p-card>

        </div>

        <!-- Columna derecha: Visitas e Interacciones -->
        <div class="space-y-6">

          <!-- Visitas Técnicas -->
          <p-card>
            <ng-template pTemplate="header">
              <div class="flex items-center justify-between p-4">
                <div>
                  <span class="font-semibold text-lg">Visitas Técnicas</span>
                  <p class="text-sm text-surface-500 mt-1">
                    {{ detalle()!.visitasTecnicas.length }} registro(s)
                  </p>
                </div>
                <p-button
                  icon="pi pi-plus"
                  [rounded]="true"
                  [text]="true"
                  size="small"
                  (onClick)="abrirDialogVisita()"
                  [disabled]="!puedeCrearVisita()"
                  [pTooltip]="!puedeCrearVisita() ? obtenerMensajeBloqueoVisita() : 'Nueva visita'"
                />
              </div>
            </ng-template>

            @if (detalle()!.visitasTecnicas.length > 0) {
              <div class="space-y-4">
                @for (visita of detalle()!.visitasTecnicas; track visita.visitaTecnicaId) {
                  <div class="p-4 bg-surface-50 dark:bg-surface-900 rounded-lg border border-surface-200 dark:border-surface-700">
                    <!-- Header con estado -->
                    <div class="flex items-center justify-between mb-3">
                      <p-tag
                        [value]="visita.estadoVisita"
                        [severity]="getSeverityEstadoVisita(visita.estadoVisita)"
                      />
                      <span class="text-xs text-surface-500">
                        ID: {{ visita.visitaTecnicaId.substring(0, 8) }}...
                      </span>
                    </div>

                    <!-- Técnico asignado -->
                    <div class="mb-3">
                      <div class="flex items-center gap-2 text-surface-900 dark:text-surface-0">
                        <i class="pi pi-user text-primary"></i>
                        <span class="font-semibold">{{ visita.tecnicoAsignado }}</span>
                      </div>
                    </div>

                    <!-- Fechas -->
                    <div class="space-y-2 mb-3">
                      <div class="flex items-center gap-2 text-sm text-surface-600 dark:text-surface-400">
                        <i class="pi pi-calendar"></i>
                        <span class="font-medium">Programada:</span>
                        <span>{{ visita.fechaVisita | date: 'dd/MM/yyyy HH:mm' }}</span>
                      </div>
                      <div class="flex items-center gap-2 text-sm text-surface-600 dark:text-surface-400">
                        <i class="pi pi-clock"></i>
                        <span class="font-medium">Registrada:</span>
                        <span>{{ visita.fechaCreacion | date: 'dd/MM/yyyy HH:mm' }}</span>
                      </div>
                    </div>

                    <!-- Detalles -->
                    @if (visita.detalles) {
                      <div class="mt-3 pt-3 border-t border-surface-200 dark:border-surface-700">
                        <p class="text-sm text-surface-700 dark:text-surface-300">
                          <i class="pi pi-info-circle mr-1"></i>
                          {{ visita.detalles }}
                        </p>
                      </div>
                    }
                  </div>
                }
              </div>
            } @else {
              <div class="text-center py-8 text-surface-500">
                <i class="pi pi-calendar text-4xl mb-3 block"></i>
                <p class="font-medium">No hay visitas técnicas</p>
                <p class="text-sm mt-1">Crea la primera visita para esta orden</p>
              </div>
            }
          </p-card>

          <!-- Interacciones -->
          <p-card>
            <ng-template pTemplate="header">
              <div class="flex items-center justify-between p-4">
                <div>
                  <span class="font-semibold text-lg">Interacciones</span>
                  <p class="text-sm text-surface-500 mt-1">
                    {{ detalle()!.interacciones.length }} registro(s)
                  </p>
                </div>
                <p-button
                  icon="pi pi-plus"
                  [rounded]="true"
                  [text]="true"
                  size="small"
                  (onClick)="abrirDialogInteraccion()"
                  pTooltip="Nueva interacción"
                />
              </div>
            </ng-template>

            @if (detalle()!.interacciones.length > 0) {
              <div class="space-y-3">
                @for (interaccion of detalle()!.interacciones; track $index) {
                  <div class="p-4 bg-surface-50 dark:bg-surface-900 rounded-lg border-l-4 border-surface-200 dark:border-surface-700"
                       [ngClass]="{
                         'border-l-green-500': interaccion.estado === 'Contactado',
                         'border-l-orange-500': interaccion.estado === 'NoContactado'
                       }">
                    <!-- Header -->
                    <div class="flex items-start justify-between mb-2">
                      <div class="flex items-center gap-2">
                        <p-tag
                          [value]="interaccion.estado === 'Contactado' ? 'Contactado' : 'No Contactado'"
                          [severity]="interaccion.estado === 'Contactado' ? 'success' : 'warn'"
                          class="text-xs"
                        />
                      </div>
                      <div class="flex items-center gap-1 text-xs text-surface-500">
                        <i class="pi pi-clock"></i>
                        {{ interaccion.fechaRegistro | date: 'dd/MM/yyyy HH:mm' }}
                      </div>
                    </div>

                    <!-- Descripción -->
                    <p class="text-sm text-surface-700 dark:text-surface-300 mb-2">
                      {{ interaccion.descripcion }}
                    </p>

                    <!-- Usuario -->
                    <div class="flex items-center gap-1 text-xs text-surface-500">
                      <i class="pi pi-user"></i>
                      <span>{{ interaccion.usuario }}</span>
                    </div>
                  </div>
                }
              </div>
            } @else {
              <div class="text-center py-8 text-surface-500">
                <i class="pi pi-comments text-4xl mb-3 block"></i>
                <p class="font-medium">No hay interacciones registradas</p>
                <p class="text-sm mt-1">Registra la primera interacción con el cliente</p>
              </div>
            }
          </p-card>

        </div>
      </div>
    }

  </div>
</div>

<!-- Dialog: Nueva Visita Técnica -->
<p-dialog
  [(visible)]="showDialogVisita"
  header="Nueva Visita Técnica"
  [modal]="true"
  [style]="{ width: '500px' }"
  [dismissableMask]="true"
>
  <div class="space-y-4">
    <div>
      <label for="tecnico" class="block text-sm font-semibold mb-2">Técnico Asignado</label>
      <input
        pInputText
        id="tecnico"
        [(ngModel)]="visitaForm.tecnicoAsignado"
        placeholder="Nombre del técnico"
        class="w-full"
      />
    </div>

    <div>
      <label for="fechaVisita" class="block text-sm font-semibold mb-2">Fecha de Visita</label>
      <p-datepicker
        [(ngModel)]="visitaForm.fechaVisita"
        [showTime]="true"
        [showIcon]="true"
        dateFormat="dd/mm/yy"
        placeholder="Seleccionar fecha y hora"
        inputId="fechaVisita"
        class="w-full"
        appendTo="body"
      />
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      severity="secondary"
      [outlined]="true"
      (onClick)="showDialogVisita.set(false)"
    />
    <p-button
      label="Guardar"
      icon="pi pi-check"
      (onClick)="guardarVisita()"
      [disabled]="!visitaForm.tecnicoAsignado || !visitaForm.fechaVisita"
    />
  </ng-template>
</p-dialog>

<!-- Dialog: Nueva Interacción -->
<p-dialog
  [(visible)]="showDialogInteraccion"
  header="Nueva Interacción"
  [modal]="true"
  [style]="{ width: '500px' }"
  [dismissableMask]="true"
>
  <div class="space-y-4">
    <div>
      <label for="estadoContacto" class="block text-sm font-semibold mb-2">Estado de Contacto</label>
      <p-select
        [(ngModel)]="interaccionForm.estadoContacto"
        [options]="estadosContacto"
        optionLabel="label"
        optionValue="value"
        placeholder="Seleccionar estado"
        class="w-full"
        inputId="estadoContacto"
      />
    </div>

    <div>
      <label for="descripcion" class="block text-sm font-semibold mb-2">Descripción</label>
      <textarea
        pInputTextarea
        id="descripcion"
        [(ngModel)]="interaccionForm.descripcion"
        rows="4"
        placeholder="Describe la interacción con el cliente..."
        class="w-full"
      ></textarea>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      severity="secondary"
      [outlined]="true"
      (onClick)="showDialogInteraccion.set(false)"
    />
    <p-button
      label="Guardar"
      icon="pi pi-check"
      (onClick)="guardarInteraccion()"
      [disabled]="!interaccionForm.estadoContacto || !interaccionForm.descripcion"
    />
  </ng-template>
</p-dialog>
