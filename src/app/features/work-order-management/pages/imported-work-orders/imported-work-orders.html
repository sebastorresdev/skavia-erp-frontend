<div class="container mx-auto p-4 max-w-7xl">
  <!-- Header -->
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-2">Importar Órdenes de Trabajo</h1>
    <p class="text-gray-600 dark:text-gray-400">Carga un archivo Excel o CSV para procesar las órdenes de trabajo en lote</p>
  </div>

  <!-- Upload Section -->
  @if (!importedResult) {
    <p-card class="shadow-lg border-0 dark:bg-gray-800">
      <ng-template pTemplate="header">
        <div class="bg-linear-to-r from-primary-600 to-primary-700 dark:from-primary-700 dark:to-primary-800 px-6 py-4">
          <h2 class="text-xl font-semibold text-white flex items-center gap-2">
            <i class="pi pi-upload"></i>
            Cargar Archivo
          </h2>
        </div>
      </ng-template>

      <p-fileUpload
        #fileUpload
        name="demo[]"
        (onSelect)="onSelect($event)"
        (onRemove)="onRemove()"
        [multiple]="false"
        accept=".xls,.xlsx,.csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,text/csv"
        [maxFileSize]="5000000"
        [showUploadButton]="false"
        [showCancelButton]="false"
        chooseLabel="Seleccionar Archivo"
        class="w-full">

        <ng-template pTemplate="content" let-files>
          @if (files.length === 0) {
            <!-- Empty State -->
            <div class="flex flex-col items-center justify-center py-16 px-4">
              <div class="bg-primary-50 dark:bg-primary-900/30 p-6 rounded-full mb-4">
                <i class="pi pi-file-excel text-6xl text-primary-600 dark:text-primary-400"></i>
              </div>
              <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-2">
                Arrastra tu archivo aquí
              </h3>
              <p class="text-gray-500 dark:text-gray-400 text-center mb-1">
                o haz clic en "Seleccionar Archivo"
              </p>
              <p class="text-sm text-gray-400 dark:text-gray-500">
                Formatos soportados: Excel (.xls, .xlsx) o CSV (máx. 5MB)
              </p>
            </div>
          } @else {
            <!-- File Selected -->
            <div class="p-6">
              <div class="bg-linear-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-xl p-6 border-2 border-green-200 dark:border-green-700 mb-6">
                <div class="flex items-center gap-4">
                  <div class="bg-green-500 dark:bg-green-600 p-4 rounded-xl shadow-lg">
                    <i class="pi pi-file-excel text-4xl text-white"></i>
                  </div>
                  <div class="flex-1">
                    <h4 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-1">{{ selectedFile?.name }}</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                      Tamaño: {{ (selectedFile!.size / 1024).toFixed(2) }} KB
                    </p>
                  </div>
                  <p-badge value="Listo" severity="success" class="text-sm px-3 py-2"></p-badge>
                </div>
              </div>

              <!-- Processing State -->
              @if (isProcessing) {
                <div class="bg-primary-50 dark:bg-primary-900/20 rounded-xl p-6 mb-6 border border-primary-100 dark:border-primary-800">
                  <div class="flex items-center gap-3 mb-4">
                    <i class="pi pi-spin pi-spinner text-2xl text-primary-600 dark:text-primary-400"></i>
                    <div class="flex-1">
                      <h4 class="font-semibold text-gray-800 dark:text-gray-100 mb-1">Procesando archivo...</h4>
                      <p class="text-sm text-gray-600 dark:text-gray-400">
                        Esto puede tomar unos momentos dependiendo del tamaño del archivo
                      </p>
                    </div>
                  </div>
                  <p-progressBar mode="indeterminate" class="h-2"></p-progressBar>
                </div>
              }

              <!-- Action Buttons -->
              <div class="flex gap-3 justify-end">
                <p-button
                  label="Cancelar"
                  icon="pi pi-times"
                  severity="secondary"
                  [outlined]="true"
                  (onClick)="resetImport()"
                  [disabled]="isProcessing">
                </p-button>
                <p-button
                  label="Procesar Archivo"
                  icon="pi pi-check"
                  severity="success"
                  (onClick)="processFile()"
                  [loading]="isProcessing"
                  [disabled]="!selectedFile || isProcessing">
                </p-button>
              </div>
            </div>
          }
        </ng-template>
      </p-fileUpload>
    </p-card>
  }

  <!-- Results Section -->
  @if (importedResult) {
    <div class="space-y-6">
      <!-- Summary Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Total Procesados -->
        <p-card class="bg-linear-to-br from-primary-50 to-primary-100 dark:from-primary-900/30 dark:to-primary-800/30 border-0 shadow-md dark:border dark:border-primary-700/50">
          <div class="text-center">
            <i class="pi pi-database text-4xl text-primary-600 dark:text-primary-400 mb-3"></i>
            <h3 class="text-4xl font-bold text-gray-800 dark:text-gray-100 mb-1">{{ totalProcessed }}</h3>
            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Procesados</p>
          </div>
        </p-card>

        <!-- Importados -->
        <p-card class="bg-linear-to-br from-green-50 to-emerald-100 dark:from-green-900/30 dark:to-emerald-800/30 border-0 shadow-md dark:border dark:border-green-700/50">
          <div class="text-center">
            <i class="pi pi-check-circle text-4xl text-green-600 dark:text-green-400 mb-3"></i>
            <h3 class="text-4xl font-bold text-gray-800 dark:text-gray-100 mb-1">{{ importedResult.totalImported }}</h3>
            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Importados</p>
          </div>
        </p-card>

        <!-- Ya Existentes -->
        <p-card class="bg-linear-to-br from-yellow-50 to-amber-100 dark:from-yellow-900/30 dark:to-amber-800/30 border-0 shadow-md dark:border dark:border-yellow-700/50">
          <div class="text-center">
            <i class="pi pi-exclamation-triangle text-4xl text-yellow-600 dark:text-yellow-400 mb-3"></i>
            <h3 class="text-4xl font-bold text-gray-800 dark:text-gray-100 mb-1">{{ importedResult.totalExisting }}</h3>
            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Ya Existentes</p>
          </div>
        </p-card>

        <!-- Errores -->
        <p-card class="bg-linear-to-br from-red-50 to-rose-100 dark:from-red-900/30 dark:to-rose-800/30 border-0 shadow-md dark:border dark:border-red-700/50">
          <div class="text-center">
            <i class="pi pi-times-circle text-4xl text-red-600 dark:text-red-400 mb-3"></i>
            <h3 class="text-4xl font-bold text-gray-800 dark:text-gray-100 mb-1">{{ importedResult.skippedDetails.length }}</h3>
            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Con Errores</p>
          </div>
        </p-card>
      </div>

      <!-- Success Rate Bar -->
      <p-card class="shadow-lg border-0 dark:bg-gray-800 dark:border dark:border-gray-700">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-1">Tasa de Éxito</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400">Porcentaje de registros importados correctamente</p>
          </div>
          <div class="text-right">
            <span class="text-4xl font-bold text-primary-600 dark:text-primary-400">{{ successRate }}%</span>
          </div>
        </div>

        <div class="relative">
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-6 overflow-hidden">
            <div
              class="h-full rounded-full transition-all duration-1000 ease-out flex items-center justify-end px-3"
              [ngClass]="{
                'bg-linear-to-r from-green-500 to-green-600 dark:from-green-600 dark:to-green-700': successRate >= 80,
                'bg-linear-to-r from-yellow-500 to-yellow-600 dark:from-yellow-600 dark:to-yellow-700': successRate >= 50 && successRate < 80,
                'bg-linear-to-r from-red-500 to-red-600 dark:from-red-600 dark:to-red-700': successRate < 50
              }"
              [style.width.%]="successRate">
              @if (successRate > 10) {
                <span class="text-white font-semibold text-sm">{{ successRate }}%</span>
              }
            </div>
          </div>
        </div>
      </p-card>

      <!-- Error Details Table -->
      @if (importedResult.skippedDetails.length > 0) {
        <p-card class="shadow-lg border-0 dark:bg-gray-800 dark:border dark:border-gray-700">
          <ng-template pTemplate="header">
            <div class="bg-red-50 dark:bg-red-900/20 px-6 py-4 border-b border-red-100 dark:border-red-800">
              <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-3">
                  <div class="bg-red-500 dark:bg-red-600 p-2 rounded-lg">
                    <i class="pi pi-exclamation-circle text-xl text-white"></i>
                  </div>
                  <div>
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100">Detalles de Errores</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                      {{ importedResult.skippedDetails.length }} órdenes no pudieron procesarse
                    </p>
                  </div>
                </div>
                <p-button
                  label="Descargar Reporte"
                  icon="pi pi-download"
                  severity="danger"
                  [outlined]="true"
                  size="small"
                  (onClick)="downloadErrorReport()">
                </p-button>
              </div>
            </div>
          </ng-template>

          <p-table
            [value]="importedResult.skippedDetails"
            [paginator]="importedResult.skippedDetails.length > 10"
            [rows]="10"
            [rowsPerPageOptions]="[10, 25, 50]"
            class="p-datatable-sm"
            [tableStyle]="{'min-width': '50rem'}">

            <ng-template pTemplate="header">
              <tr>
                <th class="font-semibold text-gray-700 dark:text-gray-300" style="width: 5%">#</th>
                <th class="font-semibold text-gray-700 dark:text-gray-300" style="width: 25%">Número de Tarea</th>
                <th class="font-semibold text-gray-700 dark:text-gray-300" style="width: 70%">Razón del Error</th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-detail let-rowIndex="rowIndex">
              <tr class="hover:bg-red-50 dark:hover:bg-red-900/10">
                <td class="text-gray-600 dark:text-gray-400 font-medium">{{ rowIndex + 1 }}</td>
                <td class="font-semibold text-gray-800 dark:text-gray-200">
                  <span class="bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded-full text-sm">
                    {{ detail.workTaskNumber }}
                  </span>
                </td>
                <td class="text-red-600 dark:text-red-400">
                  <div class="flex items-start gap-2">
                    <i class="pi pi-info-circle text-red-500 dark:text-red-400 mt-1"></i>
                    <span>{{ detail.reason }}</span>
                  </div>
                </td>
              </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="3" class="text-center py-8 text-gray-500 dark:text-gray-400">
                  No hay errores para mostrar
                </td>
              </tr>
            </ng-template>
          </p-table>
        </p-card>
      }

      <!-- Action Button -->
      <div class="flex justify-end">
        <p-button
          label="Importar Otro Archivo"
          icon="pi pi-refresh"
          severity="info"
          (onClick)="resetImport()">
        </p-button>
      </div>
    </div>
  }
</div>

<p-toast position="top-right"></p-toast>
